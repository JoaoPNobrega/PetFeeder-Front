<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard PetFeeder</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    header {
      background: #4CAF50;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 2rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }
    .card h3 {
      margin-bottom: 1rem;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    button, input {
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard PetFeeder</h1>
  </header>
  <div class="container">

    <div class="card">
      <h3>Controle Remoto</h3>
      <div class="controls">
        <button onclick="abrirPorta()">üîì Abrir Porta</button>
        <input type="number" id="tempoInput" placeholder="Tempo em ms (1000 a 10000)" />
        <button onclick="definirTempo()">‚è±Ô∏è Definir Tempo de Abertura</button>
      </div>
    </div>

    <div class="card">
      <h3>√öltimos Dados</h3>
      <p><strong>Dist√¢ncia:</strong> <span id="distancia">--</span> cm</p>
      <p><strong>Potenci√¥metro:</strong> <span id="pot">--</span></p>
      <p><strong>Tempo Abertura:</strong> <span id="tempo">--</span> ms</p>
      <p><strong>Modo:</strong> <span id="modo">--</span></p>
      <p><strong>Evento:</strong> <span id="evento">--</span></p>
    </div>

    <div class="card" style="grid-column: span 2;">
      <h3>Hist√≥rico da Dist√¢ncia</h3>
      <canvas id="graficoDistancia" height="100"></canvas>
    </div>

  </div>

  <script>
    const firebaseUrl = "https://petfeed-se-default-rtdb.firebaseio.com/";

    async function abrirPorta() {
      await fetch(firebaseUrl + "comando/abrir.json", {
        method: "PUT",
        body: "true"
      });
      alert("‚úÖ Porta ser√° aberta");
    }

    async function definirTempo() {
      const tempo = parseInt(document.getElementById("tempoInput").value);
      if (tempo >= 1000 && tempo <= 10000) {
        await fetch(firebaseUrl + "comando/tempo_remoto_ms.json", {
          method: "PUT",
          body: tempo
        });
        alert(`‚úÖ Tempo definido: ${tempo} ms`);
      } else {
        alert("Informe um valor entre 1000 e 10000 ms");
      }
    }

    const ctx = document.getElementById('graficoDistancia').getContext('2d');
    const grafico = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Dist√¢ncia (cm)',
          borderColor: '#4CAF50',
          data: [],
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            display: true,
            title: { display: true, text: 'Tempo' }
          },
          y: {
            display: true,
            title: { display: true, text: 'Dist√¢ncia (cm)' },
            suggestedMin: 0,
            suggestedMax: 30
          }
        }
      }
    });

    function atualizarDashboard(dados) {
      document.getElementById('distancia').textContent = dados.distancia_cm;
      document.getElementById('pot').textContent = dados.potenciometro;
      document.getElementById('tempo').textContent = dados.tempo_aberto_ms;
      document.getElementById('modo').textContent = dados.modo;
      document.getElementById('evento').textContent = dados.evento;

      const now = new Date();
      const label = now.toLocaleTimeString();

      grafico.data.labels.push(label);
      grafico.data.datasets[0].data.push(dados.distancia_cm);

      if (grafico.data.labels.length > 20) {
        grafico.data.labels.shift();
        grafico.data.datasets[0].data.shift();
      }
      grafico.update();
    }

    async function fetchDados() {
      const res = await fetch(firebaseUrl + "estado.json");
      const dados = await res.json();
      atualizarDashboard(dados);
    }

    setInterval(fetchDados, 2000);
  </script>
</body>
</html>
